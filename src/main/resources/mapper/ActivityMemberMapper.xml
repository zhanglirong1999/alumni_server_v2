<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.edu.seu.alumni_server.dao.mapper.ActivityMemberMapper">
    <resultMap id="BaseResultMap" type="cn.edu.seu.alumni_server.dao.entity.ActivityMember">
    </resultMap>

    <select id="getActivityMemberInfosByActivityId"
        resultType="cn.edu.seu.alumni_server.controller.dto.ActivityMemberBasicInfoDTO">
        SELECT AC.account_id,
        AC.name, AC.gender, AC.avatar,
        JB.company AS job_company,
        JB.position AS job_position,
        EDU.education_id,
        EDU.education AS education_level,
        EDU.school AS education_school,
        EDU.college AS education_college,
        EDU.start_time AS education_start_year
        FROM activity AS ACT,
        activity_member AS AM,
        account AS AC,
        job AS JB,
        education AS EDU
        WHERE ACT.is_available = 1 AND
        AM.is_available = 1 AND
        AC.valid_status = 1 AND
        JB.valid_status = 1 AND
        EDU.valid_status = 1 AND
        ACT.activity_id = #{activityId} AND
        ACT.activity_id = AM.activity_id AND
        AM.account_id = AC.account_id AND
        AM.account_id = JB.account_id AND
        AM.account_id = EDU.account_id AND
        EDU.education_id = (
            SELECT EDU2.education_id
            FROM education AS EDU2
            WHERE EDU2.account_id = AC.account_id
            ORDER BY EDU2.end_time DESC, EDU2.u_time DESC
            LIMIT 1
        ) AND JB.job_id = (
            SELECT JB2.job_id
            FROM job AS JB2
            WHERE JB2.account_id = AC.account_id
            ORDER BY JB2.start_time DESC, JB2.u_time DESC
            LIMIT 1
        )
    </select>
    <update id="updateAllActivityMembersExceptStarterReadStatusByActivityId">
        UPDATE activity_member AS A
        SET A.read_status = #{readStatus}
        WHERE A.activity_id = #{activityId} AND A.is_available = 1 AND A.account_id != (
            SELECT AC.account_id
            FROM activity AS AC
            WHERE AC.activity_id = #{activityId}
        )
    </update>
    <update id="updateAllActivityMembersReadStatus">
        UPDATE activity_member AS A
        SET A.read_status = #{readStatus}
        WHERE A.activity_id = #{activityId} AND A.is_available = 1
    </update>
    <update id="updateOneActivityMemberReadStatus">
        UPDATE activity_member AS A
        SET A.read_status = #{readStatus}
        WHERE A.activity_id = #{activityId} AND A.is_available = 1 AND A.account_id = #{accountId}
    </update>
    <select id="getAvailableCreatorIdOfActivity" resultType="java.lang.Long">
        SELECT A.account_id
        FROM activity AS A
        WHERE A.activity_id = #{activityId} AND A.is_available = 1
    </select>
</mapper>